# ==============================================================================
# CONFIGURATION FOR GOLD LAYER TABLE: player_match_stats
# ==============================================================================
# This table contains aggregated statistics for each player in each match.
# Grain: One row per (match_id, player_id)
# Source: Raw `event` table
# ==============================================================================

silver_layer:
  fct_match_events:
    final_column_order:
      # Keys
      - match_id
      - _event_id
      - event_id
      - team_id
      - player_id

      # Time and Period
      - minute
      - second
      - period_value
      - period_display_name

      # Event Details
      - type_display_name
      - is_successful

      # Location
      - x
      - y
      - end_x
      - end_y

      # Enriched Qualifier Data
      - qualifiers_display_names
      - satisfied_events_types_names
      - qualifiers_values
      - satisfied_events_types

      # Partitioning Columns
      - league
      - season
      - stage_id


gold_layer:
  # Player stats by match
  player_match_stats:
    
    # --- Source and Target Table Information ---
    source_table_name: "silver.event"
    target_table_name: "gold.player_match_stats"
    
    # --- Aggregation Keys ---
    # These columns define the unique grain of the final table.
    group_by_cols:
      - match_id
      - player_id

    # --- Aggregation Logic ---
    # This section defines how to calculate each metric.
    # We are summing up the boolean flags created in the feature engineering step.
    aggregations:
    
      # Section for simple counts where we just count a single boolean flag.
      # Format: { "output_column_name": "source_flag_to_count" }
      simple_flag_counts:
        goals_scored: is_official_goal
        extra_time_goals: is_extra_time_goal
        assists: is_assist
        goals_six_yard_box: is_goal_six_yard_box
        goals_penalty_area: is_goal_penalty_area
        goals_out_of_box: is_goal_obox
        goals_right_foot: is_goal_right_foot
        goals_left_foot: is_goal_left_foot
        goals_head: is_goal_head
        goals_other_body_parts: is_goal_obp
        goals_open_play: is_goal_open_play
        goals_counter: is_goal_counter
        goals_set_piece: is_goal_set_piece
        own_goals: is_own_goal
        penalties_taken: is_official_penalty_taken
        penalties_scored: is_penalty_scored
        pso_penalties_taken: is_pso_penalty_taken
        pso_penalties_scored: is_pso_penalty_goal
        yellow_cards: is_yellow
        second_yellow_cards: is_second_yellow
        red_cards: is_red
        key_passes: is_key_pass
        total_touches: is_touches
        total_crosses: is_cross
        total_long_balls: is_valid_long_ball
        total_through_balls: is_valid_through_ball
        total_shots: is_shots_total
        total_shots_on_target: is_shot_on_target
        total_shots_off_target: is_shot_off_target
        total_woodwork_shots: is_shot_on_post
        total_shots_blocked: is_shot_blocked
        dribbles_won: is_dribble_won
        dribbles_attempted: is_valid_dribble
        aerials_total: is_duel_aerial
        aerials_won: is_duel_aerial_won
        offensive_aerials: is_offensive_duel
        defensive_aerials: is_defensive_duel
        tackles_attempted: is_tackle_attempt
        successful_tackles: is_successful_tackle
        dribbled_past: is_dribbled_past
        last_man_tackles: is_tackle_last_man
        clearances: is_clearance
        clearances_off_the_line: is_clearance_off_the_line
        interceptions_won: is_interception_won
        corners_won: is_corner_won
        corners_conceded: is_corner_conceded
        dispossessed: is_dispossessed
        fouls_committed: is_foul_committed
        was_fouled: is_foul_given
        errors: is_error
        errors_lead_to_goal: is_error_leads_to_goal
        offsides: is_offside_given
        total_saves: is_keeper_save_total
        total_claims: is_claim
        official_penalties_faced: is_official_penalty_faced
        official_penalties_saved: is_keeper_penalty_saved
        official_penalties_conceded: is_official_penalty_conceded
        pso_penalties_faced: is_pso_penalty_faced
        pso_penalties_saved: is_penalty_shootout_saved_g_k
        pso_penalties_conceded: is_penalty_shootout_conceded_g_k

      # Section for counts with more complex logic.
      # The value is a Spark SQL boolean expression.
      custom_expression_counts:
        total_passes: "is_pass_attempt AND NOT is_cross AND NOT is_keeper_throw AND NOT is_throw_in"
        accurate_passes: "(is_pass_attempt AND NOT is_cross AND NOT is_keeper_throw AND NOT is_throw_in) AND is_successful"
        unsuccessful_touches: "is_ball_touch AND NOT is_successful"
        possession: "is_pass_attempt AND NOT is_throw_in"
        accurate_crosses: "is_cross AND is_successful"
        accurate_long_balls: "is_valid_long_ball AND is_successful"
        accurate_through_balls: "is_valid_through_ball AND is_successful"
        accurate_corners: "is_corner_taken AND is_successful"
        collected_saves: "is_keeper_save_total AND is_collected"
        parried_saves: "is_keeper_save_total AND is_parried_safe"
        parried_danger_saves: "is_keeper_save_total AND is_parried_danger"
        successful_claims: "is_claim AND is_successful"

    # --- Final Presentation Layer ---
    # Defines the final schema and order of the output table.
    final_column_order:
      # PK + player info
      - match_id
      - player_id
      - player_name

      # Player stats
      - is_starting_eleven
      - minutes_played

      # Goals and Assists
      - goals_scored
      - extra_time_goals
      - assists

      - goals_six_yard_box
      - goals_penalty_area
      - goals_out_of_box

      - goals_right_foot
      - goals_left_foot
      - goals_head
      - goals_other_body_parts

      - goals_open_play
      - goals_counter
      - goals_set_piece
      - own_goals

      - penalties_taken
      - penalties_scored
      - pso_penalties_taken
      - pso_penalties_scored

      # Cards
      - yellow_cards
      - second_yellow_cards
      - red_cards

      # Passes
      - total_passes
      - accurate_passes
      - key_passes

      - possession
      - possession_percentage

      - total_touches
      - unsuccessful_touches

      - total_crosses
      - accurate_crosses
      - accurate_long_balls
      - total_long_balls
      - accurate_through_balls
      - total_through_balls

      # Shots
      - total_shots
      - total_shots_on_target
      - total_shots_off_target
      - total_woodwork_shots
      - total_shots_blocked

      # Dribbles
      - dribbles_won
      - dribbles_attempted

      # Aerials
      - aerials_won
      - offensive_aerials
      - defensive_aerials

      # Tackles
      - tackles_attempted
      - successful_tackles
      - dribbled_past
      - last_man_tackles
      - clearances
      - clearances_off_the_line
      - interceptions_won

      # Corners
      - corners_won
      - corners_conceded
      - corners_taken
      - accurate_corners
      - corners_leading_to_goal

      # Dispossessed
      - dispossessed
      - fouls_committed
      - was_fouled
      - errors
      - errors_lead_to_goal
      - offsides

      # Goalkeeping stats
      - total_saves
      - collected_saves
      - parried_saves
      - parried_danger_saves
      - successful_claims
      - total_claims

      - official_penalties_faced
      - official_penalties_saved
      - official_penalties_conceded

      - pso_penalties_faced
      - pso_penalties_saved
      - pso_penalties_conceded

      # Match info
      - start_time_utc
      - expr: pt.team_id
        name: team_id
      - expr: t1.team_name
        name: team_name
      - opposing_team_id
      - expr: t2.team_name
        name: opposing_team_name
      - is_home

      # Stage info
      - region_name
      - region_id
      - tournament_name
      - tournament_id
      - season_name
      - season_id
      - stage_name
      - expr: m.stage_id
        name: stage_id

  # Player stats by team + season 
  player_team_season_stats:
    
    # --- Source and Target Table Information ---
    source_table_name: "gold.player_team_season_stats"
    target_table_name: "gold.player_match_stats"
    
    # --- Aggregation Keys ---
    # These columns define the unique grain of the final table.
    group_by_cols:
      - season_id
      - team_id
      - player_id

    # --- Aggregation Logic ---
    # This section defines how to calculate each metric.
    # We are summing up the boolean flags created in the feature engineering step.
    aggregations:
    
      # Section for simple counts where we just count a single boolean flag.
      # Format: { "output_column_name": "source_flag_to_count" }
      flags_agg:
        minutes_played: sum

        # Goals and Assists
        goals_scored: sum
        extra_time_goals: sum
        assists: sum
        goals_six_yard_box: sum
        goals_penalty_area: sum
        goals_out_of_box: sum
        goals_right_foot: sum
        goals_left_foot: sum
        goals_head: sum
        goals_other_body_parts: sum
        goals_open_play: sum
        goals_counter: sum
        goals_set_piece: sum
        own_goals: sum
        penalties_taken: sum
        penalties_scored: sum
        pso_penalties_taken: sum
        pso_penalties_scored: sum

        # Cards
        yellow_cards: sum
        second_yellow_cards: sum
        red_cards: sum

        # Passes
        total_passes: sum
        accurate_passes: sum
        key_passes: sum
        possession: sum
        total_touches: sum
        unsuccessful_touches: sum
        total_crosses: sum
        accurate_crosses: sum
        total_long_balls: sum
        accurate_long_balls: sum
        total_through_balls: sum
        accurate_through_balls: sum

        # Shots
        total_shots: sum
        total_shots_on_target: sum
        total_shots_off_target: sum
        total_woodwork_shots: sum
        total_shots_blocked: sum

        # Dribbles
        dribbles_won: sum
        dribbles_attempted: sum

        # Aerials
        aerials_won: sum
        offensive_aerials: sum
        defensive_aerials: sum

        # Tackles
        tackles_attempted: sum
        successful_tackles: sum
        dribbled_past: sum
        last_man_tackles: sum
        clearances: sum
        clearances_off_the_line: sum
        interceptions_won: sum

        # Corners
        corners_won: sum
        corners_conceded: sum
        corners_taken: sum
        accurate_corners: sum
        corners_leading_to_goal: sum

        # Dispossessed
        dispossessed: sum
        fouls_committed: sum
        was_fouled: sum
        errors: sum
        errors_lead_to_goal: sum
        offsides: sum

        # Goalkeeping stats
        total_saves: sum
        collected_saves: sum
        parried_saves: sum
        parried_danger_saves: sum
        successful_claims: sum
        total_claims: sum
        official_penalties_faced: sum
        official_penalties_saved: sum
        official_penalties_conceded: sum
        pso_penalties_faced: sum
        pso_penalties_saved: sum
        pso_penalties_conceded: sum


      # Section for counts with more complex logic.
      # The value is a Spark SQL boolean expression.
      entity_meta:
        player_name: first
        team_name: first
        team_id: first
        region_name: first
        region_id: first
        tournament_name: first
        tournament_id: first
        season_name: first

      flag_counts:
        appearances: "*"
        games_started: is_starting_eleven

    # --- Final Presentation Layer ---
    # Defines the final schema and order of the output table.
    final_column_order:
      # PK + player info
      - player_id
      - player_name
      - tournament_name
      - tournament_id
      - season_name
      - season_id

      # Player stats
      - appearances
      - games_started
      - minutes_played

      # Goals and Assists
      - goals_scored
      - extra_time_goals
      - assists

      - goals_six_yard_box
      - goals_penalty_area
      - goals_out_of_box

      - goals_right_foot
      - goals_left_foot
      - goals_head
      - goals_other_body_parts

      - goals_open_play
      - goals_counter
      - goals_set_piece
      - own_goals

      - penalties_taken
      - penalties_scored
      - pso_penalties_taken
      - pso_penalties_scored

      # Cards
      - yellow_cards
      - second_yellow_cards
      - red_cards

      # Passes
      - total_passes
      - accurate_passes
      - key_passes

      - possession
      - total_touches
      - unsuccessful_touches

      - total_crosses
      - accurate_crosses
      - accurate_long_balls
      - total_long_balls
      - accurate_through_balls
      - total_through_balls

      # Shots
      - total_shots
      - total_shots_on_target
      - total_shots_off_target
      - total_woodwork_shots
      - total_shots_blocked

      # Dribbles
      - dribbles_won
      - dribbles_attempted

      # Aerials
      - aerials_won
      - offensive_aerials
      - defensive_aerials

      # Tackles
      - tackles_attempted
      - successful_tackles
      - dribbled_past
      - last_man_tackles
      - clearances
      - clearances_off_the_line
      - interceptions_won

      # Corners
      - corners_won
      - corners_conceded
      - corners_taken
      - accurate_corners
      - corners_leading_to_goal

      # Dispossessed
      - dispossessed
      - fouls_committed
      - was_fouled
      - errors
      - errors_lead_to_goal
      - offsides

      # Goalkeeping stats
      - total_saves
      - collected_saves
      - parried_saves
      - parried_danger_saves
      - successful_claims
      - total_claims

      - official_penalties_faced
      - official_penalties_saved
      - official_penalties_conceded

      - pso_penalties_faced
      - pso_penalties_saved
      - pso_penalties_conceded

      # Stage info
      - region_name
      - region_id

  # Team stats by match, 2 rows for each match
  team_match_stats:
    
    # --- Source and Target Table Information ---
    source_table_name: "gold.player_match_stats"
    target_table_name: "gold.team_match_stats"
    
    # --- Aggregation Keys ---
    # These columns define the unique grain of the final table.
    group_by_cols:
      - match_id
      - team_id

    # --- Aggregation Logic ---
    # This section defines how to calculate each metric.
    # We are summing up the boolean flags created in the feature engineering step.
    aggregations:
    
      # Section for simple counts where we just count a single boolean flag.
      # Format: { "output_column_name": "source_flag_to_count" }
      flags_agg:

        # Goals and Assists
        goals_scored: sum
        extra_time_goals: sum
        assists: sum
        goals_six_yard_box: sum
        goals_penalty_area: sum
        goals_out_of_box: sum
        goals_right_foot: sum
        goals_left_foot: sum
        goals_head: sum
        goals_other_body_parts: sum
        goals_open_play: sum
        goals_counter: sum
        goals_set_piece: sum
        own_goals: sum
        penalties_taken: sum
        penalties_scored: sum
        pso_penalties_taken: sum
        pso_penalties_scored: sum

        # Cards
        yellow_cards: sum
        second_yellow_cards: sum
        red_cards: sum

        # Passes
        total_passes: sum
        accurate_passes: sum
        key_passes: sum
        possession: sum
        total_touches: sum
        unsuccessful_touches: sum
        total_crosses: sum
        accurate_crosses: sum
        total_long_balls: sum
        accurate_long_balls: sum
        total_through_balls: sum
        accurate_through_balls: sum

        # Shots
        total_shots: sum
        total_shots_on_target: sum
        total_shots_off_target: sum
        total_woodwork_shots: sum
        total_shots_blocked: sum

        # Dribbles
        dribbles_won: sum
        dribbles_attempted: sum

        # Aerials
        aerials_won: sum
        offensive_aerials: sum
        defensive_aerials: sum

        # Tackles
        tackles_attempted: sum
        successful_tackles: sum
        dribbled_past: sum
        last_man_tackles: sum
        clearances: sum
        clearances_off_the_line: sum
        interceptions_won: sum

        # Corners
        corners_won: sum
        corners_conceded: sum
        corners_taken: sum
        accurate_corners: sum
        corners_leading_to_goal: sum

        # Dispossessed
        dispossessed: sum
        fouls_committed: sum
        was_fouled: sum
        errors: sum
        errors_lead_to_goal: sum
        offsides: sum

        # Goalkeeping stats
        total_saves: sum
        collected_saves: sum
        parried_saves: sum
        parried_danger_saves: sum
        successful_claims: sum
        total_claims: sum
        official_penalties_faced: sum
        official_penalties_saved: sum
        official_penalties_conceded: sum
        pso_penalties_faced: sum
        pso_penalties_saved: sum
        pso_penalties_conceded: sum


      # Section for counts with more complex logic.
      # The value is a Spark SQL boolean expression.
      entity_meta:
        start_time_utc: first
        team_name: first
        opposing_team_id: first
        opposing_team_name: first
        is_home: first
        region_name: first
        region_id: first
        tournament_name: first
        tournament_id: first
        season_name: first
        season_id: first
        stage_name: first
        stage_id: first


      # flag_counts:
      #   appearances: "*"
      #   games_started: is_starting_eleven

    # --- Final Presentation Layer ---
    # Defines the final schema and order of the output table.
    # After joining with match_summary for match results
    final_column_order:
      - match_id
      - team_id
      - team_name

      # match summary
      - start_time_utc
      - opposing_team_id
      - opposing_team_name
      - is_home

      - is_win
      - is_draw
      - is_loss

      - goals_for
      - goals_against
      - goals_for_ht
      - goals_against_ht
      - goals_for_ft
      - goals_against_ft
      - goals_for_et
      - goals_against_et
      - goals_for_pk
      - goals_against_pk

      # Goals and Assists
      - goals_scored
      - extra_time_goals
      - assists
      - goals_six_yard_box
      - goals_penalty_area
      - goals_out_of_box
      - goals_right_foot
      - goals_left_foot
      - goals_head
      - goals_other_body_parts
      - goals_open_play
      - goals_counter
      - goals_set_piece
      - own_goals_conceded

      - penalties_taken
      - penalties_scored
      - pso_penalties_taken
      - pso_penalties_scored

      # Cards
      - yellow_cards
      - second_yellow_cards
      - red_cards

      # Passes
      - total_passes
      - accurate_passes
      - key_passes

      - possession
      - possession_percentage
      - total_touches
      - unsuccessful_touches

      - total_crosses
      - accurate_crosses
      - total_long_balls
      - accurate_long_balls
      - total_through_balls
      - accurate_through_balls

      # Shots
      - total_shots
      - total_shots_on_target
      - total_shots_off_target
      - total_woodwork_shots
      - total_shots_blocked

      # Dribbles
      - dribbles_won
      - dribbles_attempted

      # Aerials
      - aerials_won
      - offensive_aerials
      - defensive_aerials

      # Tackles
      - tackles_attempted
      - successful_tackles
      - dribbled_past
      - last_man_tackles
      - clearances
      - clearances_off_the_line
      - interceptions_won

      # Corners
      - corners_won
      - corners_conceded
      - corners_taken
      - accurate_corners
      - corners_leading_to_goal

      # Dispossessed
      - dispossessed
      - fouls_committed
      - was_fouled
      - errors
      - errors_lead_to_goal
      - offsides

      # Goalkeeping stats
      - total_saves
      - collected_saves
      - parried_saves
      - parried_danger_saves
      - successful_claims
      - total_claims
      - official_penalties_faced
      - official_penalties_saved
      - official_penalties_conceded
      - pso_penalties_faced
      - pso_penalties_saved
      - pso_penalties_conceded

      - region_name
      - region_id
      - tournament_name
      - tournament_id
      - season_name
      - season_id


  # Team stats by match, 2 rows for each match
  team_season_stats:
    
    # --- Source and Target Table Information ---
    source_table_name: "gold.team_match_stats"
    target_table_name: "gold.team_season_stats"
    
    # --- Aggregation Keys ---
    # These columns define the unique grain of the final table.
    group_by_cols:
      - season_id
      - team_id

    # --- Aggregation Logic ---
    # This section defines how to calculate each metric.
    # We are summing up the boolean flags created in the feature engineering step.
    aggregations:
    
      # Section for simple counts where we just count a single boolean flag.
      # Format: { "output_column_name": "source_flag_to_count" }
      flags_agg:
        # Match score
        goals_for: sum
        goals_against: sum

        # Goals and Assists
        goals_scored: sum
        extra_time_goals: sum
        assists: sum
        goals_six_yard_box: sum
        goals_penalty_area: sum
        goals_out_of_box: sum
        goals_right_foot: sum
        goals_left_foot: sum
        goals_head: sum
        goals_other_body_parts: sum
        goals_open_play: sum
        goals_counter: sum
        goals_set_piece: sum
        own_goals_conceded: sum
        penalties_taken: sum
        penalties_scored: sum
        pso_penalties_taken: sum
        pso_penalties_scored: sum

        # Cards
        yellow_cards: sum
        second_yellow_cards: sum
        red_cards: sum

        # Passes
        total_passes: sum
        accurate_passes: sum
        key_passes: sum
        possession_percentage: avg
        total_touches: sum
        unsuccessful_touches: sum
        total_crosses: sum
        accurate_crosses: sum
        total_long_balls: sum
        accurate_long_balls: sum
        total_through_balls: sum
        accurate_through_balls: sum

        # Shots
        total_shots: sum
        total_shots_on_target: sum
        total_shots_off_target: sum
        total_woodwork_shots: sum
        total_shots_blocked: sum

        # Dribbles
        dribbles_won: sum
        dribbles_attempted: sum

        # Aerials
        aerials_won: sum
        offensive_aerials: sum
        defensive_aerials: sum

        # Tackles
        tackles_attempted: sum
        successful_tackles: sum
        dribbled_past: sum
        last_man_tackles: sum
        clearances: sum
        clearances_off_the_line: sum
        interceptions_won: sum

        # Corners
        corners_won: sum
        corners_conceded: sum
        corners_taken: sum
        accurate_corners: sum
        corners_leading_to_goal: sum

        # Dispossessed
        dispossessed: sum
        fouls_committed: sum
        was_fouled: sum
        errors: sum
        errors_lead_to_goal: sum
        offsides: sum

        # Goalkeeping stats
        total_saves: sum
        collected_saves: sum
        parried_saves: sum
        parried_danger_saves: sum
        successful_claims: sum
        total_claims: sum
        official_penalties_faced: sum
        official_penalties_saved: sum
        official_penalties_conceded: sum
        pso_penalties_faced: sum
        pso_penalties_saved: sum
        pso_penalties_conceded: sum


      # Section for counts with more complex logic.
      # The value is a Spark SQL boolean expression.
      entity_meta:
        team_name: first
        region_name: first
        region_id: first
        tournament_name: first
        tournament_id: first
        season_name: first


      flag_counts:
        matches: "*"
        wins: is_win
        draws: is_draw
        losses: is_loss

    # --- Final Presentation Layer ---
    # Defines the final schema and order of the output table.
    # After joining with match_summary for match results
    final_column_order:
      - tournament_name
      - tournament_id
      - season_name
      - season_id
      - team_id
      - team_name

      # match summary
      - matches
      - wins
      - draws
      - losses

      - goals_for
      - goals_against

      # Goals and Assists
      - goals_scored
      - extra_time_goals
      - assists
      - goals_six_yard_box
      - goals_penalty_area
      - goals_out_of_box
      - goals_right_foot
      - goals_left_foot
      - goals_head
      - goals_other_body_parts
      - goals_open_play
      - goals_counter
      - goals_set_piece
      - own_goals_conceded

      - penalties_taken
      - penalties_scored
      - pso_penalties_taken
      - pso_penalties_scored

      # Cards
      - yellow_cards
      - second_yellow_cards
      - red_cards

      # Passes
      - total_passes
      - accurate_passes
      - key_passes

      - possession_percentage
      - total_touches
      - unsuccessful_touches

      - total_crosses
      - accurate_crosses
      - total_long_balls
      - accurate_long_balls
      - total_through_balls
      - accurate_through_balls

      # Shots
      - total_shots
      - total_shots_on_target
      - total_shots_off_target
      - total_woodwork_shots
      - total_shots_blocked

      # Dribbles
      - dribbles_won
      - dribbles_attempted

      # Aerials
      - aerials_won
      - offensive_aerials
      - defensive_aerials

      # Tackles
      - tackles_attempted
      - successful_tackles
      - dribbled_past
      - last_man_tackles
      - clearances
      - clearances_off_the_line
      - interceptions_won

      # Corners
      - corners_won
      - corners_conceded
      - corners_taken
      - accurate_corners
      - corners_leading_to_goal

      # Dispossessed
      - dispossessed
      - fouls_committed
      - was_fouled
      - errors
      - errors_lead_to_goal
      - offsides

      # Goalkeeping stats
      - total_saves
      - collected_saves
      - parried_saves
      - parried_danger_saves
      - successful_claims
      - total_claims
      - official_penalties_faced
      - official_penalties_saved
      - official_penalties_conceded
      - pso_penalties_faced
      - pso_penalties_saved
      - pso_penalties_conceded

      - region_name
      - region_id